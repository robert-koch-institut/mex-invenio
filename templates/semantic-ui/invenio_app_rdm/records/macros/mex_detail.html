{#
Copyright (C) 2020-2024 CERN.
Copyright (C) 2024 Northwestern University.

Invenio RDM Records is free software; you can redistribute it and/or modify
it under the terms of the MIT License; see LICENSE file for more details.
#}


{%- from "invenio_app_rdm/records/macros/pref_labels.jinja" import pref_labels %}
{%- from "invenio_app_rdm/records/macros/fields_types.jinja" import field_types %}


{# Display date in user-friendly format #}
{% macro format_date(date_str) %}
    {%- set months = {
        '01': 'Jan', '02': 'Feb', '03': 'Mar', '04': 'Apr',
        '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Aug',
        '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dec'
    } %}

    {%- if date_str is string and date_str|length >= 10 %}
        {# Format: YYYY-MM-DD or full timestamp #}
        {%- set year = date_str[0:4] %}
        {%- set month = date_str[5:7] %}
        {%- set day = date_str[8:10] %}
        {{ months[month] }} {{ day|int }}, {{ year }}

    {%- elif date_str is string and date_str|length == 7 %}
        {# Format: YYYY-MM #}
        {%- set year = date_str[0:4] %}
        {%- set month = date_str[5:7] %}
        {{ months[month] }} {{ year }}

    {%- elif date_str is string and date_str|length == 4 %}
        {# Format: YYYY #}
        {{ date_str }}

    {%- else %}
        {{ date_str }} {# fallback if it doesn't match any expected format #}
    {%- endif %}
{% endmacro %}

{% macro render_text(items) %}
    {%- set lang = current_i18n.language -%}
    {%- set first_item = items[0] if items|length > 0 else {} -%}
    {%- set has_language = 'language' in first_item -%}

    {%- if has_language -%}
        {%- set matching_items = items | selectattr('language', 'equalto', lang) | list -%}
        {%- set items_to_display = matching_items if matching_items | length > 0 else items -%}
    {%- else -%}
        {%- set items_to_display = items -%}
    {%- endif -%}

    {%- for item in items_to_display -%}
        <p>{{ item.value }}</p>
    {%- endfor -%}
{% endmacro %}

{% macro render_url(items) %}
    {%- for item in items -%}
        <a href="{{ item.link }}">{{ item.value or item.link }}</a>{% if not loop.last %}, {% endif %}
    {%- endfor -%}
{% endmacro %}

{% macro render_extid(values) %}
    {%- for val in values -%}
        {%- if val.startswith("http") -%}
            <a href="{{ val }}">{{ val.split('/')[-1] }}</a>{% if not loop.last %}, {% endif %}
        {%- else -%}
            {{ val }}{% if not loop.last %}, {% endif %}
        {%- endif -%}
    {%- endfor -%}
{% endmacro %}

{% macro render_label(values) %}
    {%- set lang = current_i18n.language.language -%}
    {%- for val in values -%}
        {{ pref_labels.get(val, {}).get(lang, val) }}{% if not loop.last %}, {% endif %}
    {%- endfor -%}
{% endmacro %}

{% macro render_identifier(identifiers) %}
    {{ linked_records_data }}
    {% for id in identifiers %}
        {% if id.display_value %}
            {% set first = id.display_value[0] %}
            {% if first is string %}
                <a href="{{ id.link_id }}">{{ id.display_value | join(', ') }}</a>
            {% elif first.value is defined %}
                <a href="{{ id.link_id }}">{{ id.display_value | join(', ') }}</a>
            {% else %}
                <a href="{{ id.link_id }}">[No name]</a>
            {% endif %}
        {% else %}
            [No value]
        {% endif %}
    {% endfor %}
{% endmacro %}


{%- macro val(field_name, resource_type) -%}
    {%- set field_raw_value = record.ui.custom_fields.get(field_name) -%}

    {%- if not field_raw_value -%}
        <span class="empty">-</span>

    {%- else -%}
        {# Normalize: wrap single values into a list #}
        {%- if field_raw_value is string or field_raw_value is number -%}
            {%- set values = [field_raw_value] -%}
        {%- else -%}
            {%- set values = field_raw_value -%}
        {%- endif -%}

        {# Infer type from config #}
        {%- set type = field_types.get(resource_type).get(field_name) -%}
        <p style="color: red">{{ type }}</p>
        <p style="color: blue">{{ values }}</p>
        {%- if type == "string" or type == "int" -%}
            {{ values | join(", ") }}
        {%- elif type == "text" -%}
            {{ render_text(values) }}
        {%- elif type == "url" -%}
            {{ render_url(values) }}
        {%- elif type == "extid" -%}
            {{ render_extid(values) }}
        {%- elif type == "date" -%}
            {{ render_date(values) }}
        {%- elif type == "label" -%}
            {{ render_label(values) }}
        {%- elif type == "identifier" -%}
            {{ render_identifier(values) }}
        {%- else -%}
            {%- for val in values -%}{{ val }}{% if not loop.last %}, {% endif %}{% endfor %}
        {%- endif -%}
    {%- endif -%}
{%- endmacro %}

