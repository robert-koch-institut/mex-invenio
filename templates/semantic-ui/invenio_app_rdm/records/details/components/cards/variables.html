{%- from "invenio_app_rdm/records/macros/mex_detail.html" import render_3_variables with context %}
{% set max_variables = 3 %}
{% set card_name = "variables" %}
{% set cards = config.RECORD_CARDS.resource[column] %}
{% set card = config.RECORD_CARDS.resource[column][card_name] %}

{% set ns = namespace(prop_exist=false, value=none) %}
{% if linked_records_data and card.is_backwards_linked %}
    {% set record_data = linked_records_data["backwards_linked"] %}
    {% for prop in card.properties %}
        {% if prop in record_data %}
            {% set ns.value = record_data[prop] %}
            {% set ns.prop_exist = true %}
        {% endif %}
    {% endfor %}
{% else %}
    {% set record_data = record.ui.custom_fields %}
    {% for prop in card.properties %}
        {% if prop in record.ui.custom_fields %}
            {% set ns.value = record.ui.custom_fields[prop] %}
            {% if ns.value %}
                {% set ns.prop_exist = true %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}
{% if ns.prop_exist %}
    <div class="card">
        <h3>
            <img class="ui image icon"
                 src="{{ url_for('static', filename='icons/' ~ card.icon) }}"
                 alt=""/>
            {{ _(card.title) }}
        </h3>
        <div class="card-props">
            {% for prop in card.properties %}
                {% set value = render_3_variables(record_data[prop]) %}
                {% if value %}
                    <div class="card-props-p">
                        <p class="card-prop-label" title="{{ _(config.FIELD_LABELS_UI[prop]) }}">{{ _(config.FIELD_LABELS_UI[prop]) }}</p>
                        <div class="card-prop-value">{{ value }}</div>
                    </div>
                {% endif %}
                {% set variables_count = record_data[prop] | length %}
                {% if variables_count > max_variables %}
                        <a class="card-prop-label" id="see-all-modal-trigger" style="cursor: pointer">
                            {{ _('See all %(count)s variables', count=variables_count) }}
                        </a>
                    <button class="disabled" disabled>
                        {{ _('See all variables in the variables search page') }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endif %}

<style>
    .modal-wrapper {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(100,100,100,0.5);
    }

    .modal-wrapper > .ui.modal {
        display: block;
        position: relative;
        top: 25%;
        left: 25%;
        width: 50%;
        height: 50%;
        overflow-y: scroll;
    }

    #card-properties-modal > div.content > ul > div > div > a { padding-bottom: .5rem }
</style>

<div class="modal-wrapper" id="card-properties-modal">
    <div class="ui modal card">
        <div class="header">{{ _('All variables') }}</div>
        <div class="content">
            <p>{{ _('Here are all the variables for this card:') }}</p>
            <div class="card-props" style="grid-template-columns: 100%;">
                {% for prop in card.properties %}
                    {% set value = val(prop, record_data[prop], resource_type, card.is_backwards_linked) %}
                    {% if value %}
                        <div class="card-props-p variables-list" style="display: block">
                            <div class="card-prop-value">{{ value }}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class="actions">
            <div class="ui approve button" id="close-variables-modal">{{ _('Close') }}</div>
        </div>
        </div>
    </div>
</div>

<script>
    const trigger_link = document.getElementById('see-all-modal-trigger')
    trigger_link.addEventListener('click', e => {
        e.preventDefault();
        const modal = document.getElementById('card-properties-modal');
        const modal_back = document.getElementById('variables-modal-backdrop');
        if (modal) {
            modal.style.display = 'block';
        }
    });

    const modal = document.getElementById('card-properties-modal');
    const closeBtn = document.getElementById('close-variables-modal');

    if (closeBtn && modal) {
    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // Close modal if click outside modal-content
    modal.addEventListener('click', e => {
        // If click target is the modal itself (background), close it
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    }

</script>
